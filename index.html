<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" type="text/css" href="http://ajax.aspnetcdn.com/ajax/jquery.dataTables/1.9.4/css/jquery.dataTables.css">
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="css/datatables.css" />
    <title>EWMI G-PAC Sub-Grants</title>
  </head>
  <body>

    <div class="container-fluid">
      <div class="filter_container">
        <div class="row">
          <div class="filter_budget col-sm-4" data-type="budget" data-analysis="between">
            Budget: 
            <select>
              <option value="0">All</option>
              <option value="-10000">&lt; 10,000</option>
              <option value="10000-20000">10,000 - 20,000</option>
              <option value="20000-">&gt; 20,000</option>
            </select>
          </div>
          <div class="filter_start_date col-sm-4" style="display:none;" data-type="start_date" data-analysis="year">
            Start Year: 
            <select></select>
          </div>
          <div class="filter_end_date col-sm-4" style="display:none;" data-type="end_date" data-analysis="year">
            End Year: 
            <select></select>
          </div>
        </div>
        <div class="row">
          <div class="filter_type col-sm-4" style="display:none;" data-type="type">
            Grant Type: 
            <select></select>
          </div>
          <div class="filter_topic col-sm-4" style="display:none;" data-type="topic">
            Topic / Area: 
            <select></select>
          </div>
          <div class="filter_budget col-sm-4" data-type="region" data-analysis="in-string">
            Region: 
            <select>
              <option value="0">All</option>
              <option value="Adjara" data_id="1">Adjara</option>
              <option value="Guria" data_id="2">Guria</option>
              <option value="Imereti" data_id="3">Imereti</option>
              <option value="Kakheti" data_id="4">Kakheti</option>
              <option value="Kvemo Kartli" data_id="5">Kvemo Kartli</option>
              <option value="Mtskheta-Mtianeti" data_id="6">Mtskheta-Mtianeti</option>
              <option value="Racha-Lechkumi / Kvemo Svaneti" data_id="7">Racha-Lechkumi / Kvemo Svaneti</option>
              <option value="Samegrelo / Zemo Svaneti" data_id="8">Samegrelo / Zemo Svaneti</option>
              <option value="Samtskhe-Javakheti" data_id="9">Samtskhe-Javakheti</option>
              <option value="Shida Kartli" data_id="10">Shida Kartli</option>
              <option value="Tbilisi" data_id="11">Tbilisi</option>
            </select>
          </div>
        </div>
      </div>
      <div class="map">
        map
      </div>
      <div class="table_container table-responsive">
        <table id="data_table" class="table table-striped table-bordered table-hover" >
          <thead>
            <tr>
              <th>
                Grantee
              </th>
              <th>
                Project Title
              </th>
              <th>
                Budget
              </th>
              <th>
                Start Date
              </th>
              <th>
                End Date
              </th>
              <th>
                Grant Type
              </th>
              <th>
                Topic / Area
              </th>
              <th>
                Description
              </th>
              <th>
                Region
              </th>
            </tr>
          </thead>
          <tbody>
          </tbody>
        </table>
      </div>
    </div>      



    <script type="text/javascript" charset="utf8" src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.8.2.min.js"></script>
    <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/numeral.js/1.4.5/numeral.min.js"></script>
    <script type="text/javascript" charset="utf8" src="http://ajax.aspnetcdn.com/ajax/jquery.dataTables/1.9.4/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="js/datatables.js"></script>
    <script>
      var json_data, data_table, filter_data;

      $(document).ready(function(){
        // update the data table with the provided data
        function update_data_table(data){
          data_table.fnClearTable();
          data_table.fnAddData(data);
          data_table.fnDraw();
        }

        // get unique values from array
        function unique(array) {
          return $.grep(array, function(el, index) {
            return index == $.inArray(el, array);
          });
        }

        // reload the list that has the class name of 'filter_key', where key is passed in
        function reload_select_list(key, is_date, data){
          var objs;
          if (is_date){
            objs = $.map(data, function(item,i){return item[key].split('/')[2]});
          }else {
            objs = $.map(data, function(item,i){return item[key]});
          }
          var uniq_objs = unique(objs).sort();
          var existing_value = $('.filter_' + key + ' select').val();
          $('.filter_' + key + ' select').empty();
          $('.filter_' + key + ' select')
             .append($("<option></option>")
             .attr("value",'0')
             .text('All')); 
          $.each(uniq_objs, function(index, value) {   
               $('.filter_' + key + ' select')
                   .append($("<option></option>")
                   .attr("value",value)
                   .text(value)); 
          });
          $('.filter_' + key + ' select').val(existing_value);
          $('.filter_' + key + '').show();
        }

        // update the datatable and filters using the data provided
        function refresh_data(data){
          // update the data table with the new data
          update_data_table(data);

          // reload the lists
          reload_select_list('type', false, data);
          reload_select_list('topic', false, data);
          reload_select_list('start_date', true, data);
          reload_select_list('end_date', true, data);   
        }

        // special sorts
        jQuery.extend( jQuery.fn.dataTableExt.oSort, {
            "formatted-num-pre": function ( a ) {
                a = (a === "-" || a === "") ? 0 : a.replace( /[^\d\-\.]/g, "" );
                return parseFloat( a );
            },
         
            "formatted-num-asc": function ( a, b ) {
                return a - b;
            },
         
            "formatted-num-desc": function ( a, b ) {
                return b - a;
            }
        } );

        jQuery.fn.dataTableExt.oSort['us_date-asc'] = function (a, b) {
            var x = new Date(a),
             y = new Date(b);
            return ((x < y) ? -1 : ((x > y) ? 1 : 0));
        };

        jQuery.fn.dataTableExt.oSort['us_date-desc'] = function (a, b) {
            var x = new Date(a),
             y = new Date(b);
            return ((x < y) ? 1 : ((x > y) ? -1 : 0));
        };


        
        // get the json data and then load the page
        $.getJSON( "./data/data.json", function( data ) {
          json_data = data;

          // load data table
          data_table = $('#data_table').dataTable({
            "sPaginationType": "bs_normal",
            "bProcessing": true,
            "iDisplayLength": 20,
            "aLengthMenu": [[20, 40, 60, 80], [20, 40, 60, 80]],
            "aoColumns": [
                { "mData": "grantee" },
                { "mData": "title" },
                { "mData": "desc" },
                { "mData": "budget", "sType": "formatted-num", 
                    "mRender": function ( data, type, full ) {return numeral(data).format('$0,0.00');}  
                },
                { "mData": "start_date", "sType": "us_date" },
                { "mData": "end_date", "sType": "us_date" },
                { "mData": "type" },
                { "mData": "topic" },
                { "mData": "region" }
            ]
          });
          
          // load the data into the table and load the filters
          refresh_data(json_data);          
          


          // register filter type event
          $('.filter_container select').change(function(){
            // for each filter in the container
            // - build a filter statement if needed
            // - then filter the data
            var filters = [];
            // for each select box, get filter value if one is selected
            $(this).parent().parent().find('select').each(function(){
              if ($(this).val() != "0"){
                filters.push([$(this).parent().data('type'), $(this).val(), $(this).parent().data('analysis')]);
              }
            });

            var filter_data;
            // if no filters, then default to original data
            // else, filter the data
            if (filters.length == 0){
              filter_data = json_data;
            }else{
              filter_data = $.grep(json_data, function( item, i ) {
                var test = true;
                $(filters).each(function(){
                  if ($(this)[2] != undefined && $(this)[2] == 'between'){
                    // see if value is between these bounds
                    // filter value: x-y
                    // - x = lower limit (>= to)
                    // - y = upper limit (<)
                    var between = $(this)[1].split('-');
                    if (between[0].length > 0){
                      test = test && item[$(this)[0]] >= between[0];
                    }                 
                    if (between[1].length > 0){
                      test = test && item[$(this)[0]] < between[1];
                    }                 
                    
                  } else if ($(this)[2] != undefined && $(this)[2] == 'year'){
                    // only compare the year of the date
                    test = test && item[$(this)[0]].split('/')[2] == $(this)[1];
                    
                  } else if ($(this)[2] != undefined && $(this)[2] == 'in-string'){
                    // see if the value is anywhere in the string
                    test = test && item[$(this)[0]].indexOf($(this)[1]) != -1;
                    
                  }else{
                    test = test && item[$(this)[0]] == $(this)[1];
                  }
                });
                return ( test );
              });
            }

            // update the data table and filters
            refresh_data(filter_data);          


          });  
  
        });

        
        
      });
    </script>
  </body>
</html>

