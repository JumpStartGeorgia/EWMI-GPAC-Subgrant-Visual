<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.css" />
    <link rel="stylesheet" type="text/css" href="http://ajax.aspnetcdn.com/ajax/jquery.dataTables/1.9.4/css/jquery.dataTables.css">
    <title>EWMI G-PAC Sub-Grants</title>

    <style>/* datatable bootstrap styles */
div.dataTables_length label{float:left;text-align:left}div.dataTables_length select{width:75px}div.dataTables_filter label{float:right}div.dataTables_info{padding-top:26px}div.dataTables_paginate{float:right;margin:0}table.table{clear:both;margin-bottom:6px !important;max-width:none !important}table.table thead .sorting,table.table thead .sorting_asc,table.table thead .sorting_desc,table.table thead .sorting_asc_disabled,table.table thead .sorting_desc_disabled{cursor:pointer;*cursor:hand}table.table thead .sorting{background:url('./images/sort_both.png') no-repeat center right}table.table thead .sorting_asc{background:url('./images/sort_asc.png') no-repeat center right}table.table thead .sorting_desc{background:url('./images/sort_desc.png') no-repeat center right}table.table thead .sorting_asc_disabled{background:url('./images/sort_asc_disabled.png') no-repeat center right}table.table thead .sorting_desc_disabled{background:url('./images/sort_desc_disabled.png') no-repeat center right}table.dataTable th:active{outline:0}div.dataTables_scrollHead table{margin-bottom:0 !important;border-bottom-left-radius:0;border-bottom-right-radius:0}div.dataTables_scrollHead table thead tr:last-child th:first-child,div.dataTables_scrollHead table thead tr:last-child td:first-child{border-bottom-left-radius:0 !important;border-bottom-right-radius:0 !important}div.dataTables_scrollBody table{border-top:0;margin-bottom:0 !important}div.dataTables_scrollBody tbody tr:first-child th,div.dataTables_scrollBody tbody tr:first-child td{border-top:0}div.dataTables_scrollFoot table{border-top:0}.table tbody tr.active td,.table tbody tr.active th{background-color:#08C;color:white}.table tbody tr.active:hover td,.table tbody tr.active:hover th{background-color:#0075b0 !important}.table-striped tbody tr.active:nth-child(odd) td,.table-striped tbody tr.active:nth-child(odd) th{background-color:#017ebc}table.DTTT_selectable tbody tr{cursor:pointer;*cursor:hand}div.DTTT .btn{color:#333 !important;font-size:12px}div.DTTT .btn:hover{text-decoration:none !important}ul.DTTT_dropdown.dropdown-menu a{color:#333 !important}ul.DTTT_dropdown.dropdown-menu li:hover a{background-color:#08c;color:white !important}div.DTTT_print_info.modal{height:150px;margin-top:-75px;text-align:center}div.DTTT_print_info h6{font-weight:normal;font-size:28px;line-height:28px;margin:1em}div.DTTT_print_info p{font-size:14px;line-height:20px}div.DTFC_LeftHeadWrapper table,div.DTFC_LeftFootWrapper table,table.DTFC_Cloned tr.even{background-color:white}div.DTFC_LeftHeadWrapper table{margin-bottom:0 !important;border-top-right-radius:0 !important;border-bottom-left-radius:0 !important;border-bottom-right-radius:0 !important}div.DTFC_LeftHeadWrapper table thead tr:last-child th:first-child,div.DTFC_LeftHeadWrapper table thead tr:last-child td:first-child{border-bottom-left-radius:0 !important;border-bottom-right-radius:0 !important}div.DTFC_LeftBodyWrapper table{border-top:0;margin-bottom:0 !important}div.DTFC_LeftBodyWrapper tbody tr:first-child th,div.DTFC_LeftBodyWrapper tbody tr:first-child td{border-top:0}div.DTFC_LeftFootWrapper table{border-top:0}
    </style>    
    <style>
      .popup {
        padding: 6px 8px;
        font: 14px/16px Arial, Helvetica, sans-serif;
        background: white;
        background: rgba(255,255,255,0.8);
        box-shadow: 0 0 15px rgba(0,0,0,0.2);
        border-radius: 5px;
      }
      .popup h4 {
        margin: 0 0 5px;
        color: #777;
      }

      .legend {
        line-height: 18px;
        color: #000;
      }
      .legend i {
        width: 18px;
        height: 18px;
        float: left;
        margin-right: 8px;
        opacity: 0.9;
      }

      .filter_container{
        margin-bottom: 20px;
      }
      .map_container{
        width: 700px; 
        margin: 0 auto;
        margin-bottom: 20px;
      }
      #map_impl, #map_grantee{
        height: 330px;
      }
      
      .table_container .budget_total{
        background-color: #006d2c;
        color: #fff;
        display: inline-block;
        padding: 5px 10px;
        margin-top: -5px;        
      } 
    </style>
  </head>
  <body>

    <div class="container">
      <div class="filter_container">
        <div class="row">
          <div class="filter_budget col-sm-4" data-type="budget" data-analysis="between">
            <label for="filter_budget">Budget:</label>
            <select id="filter_budget">
              <option value="0">All</option>
              <option value="-10000">&lt; 10,000</option>
              <option value="10000-20000">10,000 - 20,000</option>
              <option value="20000-30000">20,000 - 30,000</option>
              <option value="30000-40000">30,000 - 40,000</option>
              <option value="40000-50000">40,000 - 50,000</option>
              <option value="50000-">&gt; 50,000</option>
            </select>
          </div>
          <div class="filter_start_date col-sm-4" data-type="start_date" data-analysis="year">
            <label for="filter_start_date">Start Year:</label>
            <select id="filter_start_date"></select>
          </div>
          <div class="filter_end_date col-sm-4" data-type="end_date" data-analysis="year">
            <label for="filter_end_date">End Year:</label>
            <select id="filter_end_date"></select>
          </div>
        </div>
        <div class="row">
          <div class="filter_grantee_location col-sm-6" data-type="grantee_location" data-analysis="in-string">
            <label for="filter_grantee_location">Grantee Location:</label>
            <select id="filter_grantee_location">
              <option value="0">All</option>
              <option value="Adjara" data-id="1">Adjara</option>
              <option value="Guria" data-id="2">Guria</option>
              <option value="Imereti" data-id="3">Imereti</option>
              <option value="Kakheti" data-id="4">Kakheti</option>
              <option value="Kvemo Kartli" data-id="5">Kvemo Kartli</option>
              <option value="Mtskheta-Mtianeti" data-id="7">Mtskheta-Mtianeti</option>
              <option value="Racha-Lechkumi / Kvemo Svaneti" data-id="8">Racha-Lechkumi / Kvemo Svaneti</option>
              <option value="Samegrelo / Zemo Svaneti" data-id="11">Samegrelo / Zemo Svaneti</option>
              <option value="Samtskhe-Javakheti" data-id="6">Samtskhe-Javakheti</option>
              <option value="Shida Kartli" data-id="9">Shida Kartli</option>
              <option value="Tbilisi" data-id="32">Tbilisi</option>
            </select>
          </div>
          <div class="filter_impl_location col-sm-6" data-type="impl_location" data-analysis="in-string">
            <label for="filter_impl_location">Implementation Location:</label>
            <select id="filter_impl_location">
              <option value="0">All</option>
              <option value="Adjara" data-id="1">Adjara</option>
              <option value="Guria" data-id="2">Guria</option>
              <option value="Imereti" data-id="3">Imereti</option>
              <option value="Kakheti" data-id="4">Kakheti</option>
              <option value="Kvemo Kartli" data-id="5">Kvemo Kartli</option>
              <option value="Mtskheta-Mtianeti" data-id="7">Mtskheta-Mtianeti</option>
              <option value="Racha-Lechkumi / Kvemo Svaneti" data-id="8">Racha-Lechkumi / Kvemo Svaneti</option>
              <option value="Samegrelo / Zemo Svaneti" data-id="11">Samegrelo / Zemo Svaneti</option>
              <option value="Samtskhe-Javakheti" data-id="6">Samtskhe-Javakheti</option>
              <option value="Shida Kartli" data-id="9">Shida Kartli</option>
              <option value="Tbilisi" data-id="32">Tbilisi</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div class="filter_type col-sm-4" data-type="type">
            <label for="filter_type">Grant Type:</label>
            <select id="filter_type"></select>
          </div>
          <div class="filter_topic col-sm-4" data-type="topic">
            <label for="filter_topic">Topic / Area:</label>
            <select id="filter_topic"></select>
          </div>
          <div class="col-sm-4">
            <button type="button" id="reset_filters" class="btn btn-info btn-xs">Clear Filters</button>
          </div>
        </div>
      </div>
      
      
      <div class="map_container">
        <ul class="nav nav-tabs">
          <li class="active"><a href="#pane_map_impl" data-toggle="tab" data-type="impl">Implementation Location Summary Map</a></li>
          <li><a href="#pane_map_grantee" data-toggle="tab" data-type="grantee">Grantee Location Summary Map</a></li>
        </ul>
        <div class="tab-content">
          <div class="tab-pane fade in active" id="pane_map_impl">
            <div id="map_impl"></div>
          </div>
          <div class="tab-pane fade" id="pane_map_grantee">
            <div id="map_grantee"></div>
          </div>
        </div>
      </div>      
      
      <div class="table_container table-responsive">
        <table id="data_table" class="table table-striped table-bordered table-hover" >
          <thead>
            <tr>
              <th>
                Grantee
              </th>
              <th>
                Project Title
              </th>
              <th>
                Description
              </th>
              <th>
                Budget
              </th>
              <th>
                Start Date
              </th>
              <th>
                End Date
              </th>
              <th>
                Grantee Location
              </th>
              <th>
                Implementation Location
              </th>
              <th>
                Grant Type
              </th>
              <th>
                Topic / Area
              </th>
            </tr>
          </thead>
          <tbody>
          </tbody>
        </table>
      </div>
    </div>      



    <script type="text/javascript" charset="utf8" src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.8.2.min.js"></script>
    <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/numeral.js/1.4.5/numeral.min.js"></script>
    <script src="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.js"></script>
    <script type="text/javascript" charset="utf8" src="http://ajax.aspnetcdn.com/ajax/jquery.dataTables/1.9.4/jquery.dataTables.min.js"></script>
    <script type="text/javascript">/* datatable bootstrap js */
      $.extend(true,$.fn.dataTable.defaults,{"sDom":"<'row'<'col-sm-12'<'pull-right'f><'pull-left'l><'text-center'<'budget_total'>>r<'clearfix'>>>t<'row'<'col-sm-12'<'pull-left'i><'pull-right'p><'clearfix'>>>","sPaginationType":"bs_normal","oLanguage":{"sLengthMenu":"Show _MENU_ Rows","sSearch":""}});$.extend($.fn.dataTableExt.oStdClasses,{"sWrapper":"dataTables_wrapper form-inline"});
      $.fn.dataTableExt.oApi.fnPagingInfo=function(oSettings){return{"iStart":oSettings._iDisplayStart,"iEnd":oSettings.fnDisplayEnd(),"iLength":oSettings._iDisplayLength,"iTotal":oSettings.fnRecordsTotal(),"iFilteredTotal":oSettings.fnRecordsDisplay(),"iPage":oSettings._iDisplayLength===-1?0:Math.ceil(oSettings._iDisplayStart/oSettings._iDisplayLength),"iTotalPages":oSettings._iDisplayLength===-1?0:Math.ceil(oSettings.fnRecordsDisplay()/oSettings._iDisplayLength)}};
      $.extend($.fn.dataTableExt.oPagination,{"bs_normal":{"fnInit":function(oSettings,nPaging,fnDraw){var oLang=oSettings.oLanguage.oPaginate;var fnClickHandler=function(e){e.preventDefault();if(oSettings.oApi._fnPageChange(oSettings,e.data.action))fnDraw(oSettings)};$(nPaging).append('<ul class="pagination">'+'<li class="prev disabled"><a href="#"><span class="glyphicon glyphicon-chevron-left"></span>&nbsp;'+oLang.sPrevious+"</a></li>"+'<li class="next disabled"><a href="#">'+oLang.sNext+'&nbsp;<span class="glyphicon glyphicon-chevron-right"></span></a></li>'+
      "</ul>");var els=$("a",nPaging);$(els[0]).bind("click.DT",{action:"previous"},fnClickHandler);$(els[1]).bind("click.DT",{action:"next"},fnClickHandler)},"fnUpdate":function(oSettings,fnDraw){var iListLength=5;var oPaging=oSettings.oInstance.fnPagingInfo();var an=oSettings.aanFeatures.p;var i,ien,j,sClass,iStart,iEnd,iHalf=Math.floor(iListLength/2);if(oPaging.iTotalPages<iListLength){iStart=1;iEnd=oPaging.iTotalPages}else if(oPaging.iPage<=iHalf){iStart=1;iEnd=iListLength}else if(oPaging.iPage>=oPaging.iTotalPages-
      iHalf){iStart=oPaging.iTotalPages-iListLength+1;iEnd=oPaging.iTotalPages}else{iStart=oPaging.iPage-iHalf+1;iEnd=iStart+iListLength-1}for(i=0,ien=an.length;i<ien;i++){$("li:gt(0)",an[i]).filter(":not(:last)").remove();for(j=iStart;j<=iEnd;j++){sClass=j==oPaging.iPage+1?'class="active"':"";$("<li "+sClass+'><a href="#">'+j+"</a></li>").insertBefore($("li:last",an[i])[0]).bind("click",function(e){e.preventDefault();if(oSettings.oApi._fnPageChange(oSettings,parseInt($("a",this).text(),10)-1))fnDraw(oSettings)})}if(oPaging.iPage===
      0)$("li:first",an[i]).addClass("disabled");else $("li:first",an[i]).removeClass("disabled");if(oPaging.iPage===oPaging.iTotalPages-1||oPaging.iTotalPages===0)$("li:last",an[i]).addClass("disabled");else $("li:last",an[i]).removeClass("disabled")}}},"bs_two_button":{"fnInit":function(oSettings,nPaging,fnCallbackDraw){var oLang=oSettings.oLanguage.oPaginate;var oClasses=oSettings.oClasses;var fnClickHandler=function(e){if(oSettings.oApi._fnPageChange(oSettings,e.data.action))fnCallbackDraw(oSettings)};
      var sAppend='<ul class="pagination">'+'<li class="prev"><a href="#" class="'+oSettings.oClasses.sPagePrevDisabled+'" tabindex="'+oSettings.iTabIndex+'" role="button"><span class="glyphicon glyphicon-chevron-left"></span>&nbsp;'+oLang.sPrevious+"</a></li>"+'<li class="next"><a href="#" class="'+oSettings.oClasses.sPageNextDisabled+'" tabindex="'+oSettings.iTabIndex+'" role="button">'+oLang.sNext+'&nbsp;<span class="glyphicon glyphicon-chevron-right"></span></a></li>'+"</ul>";$(nPaging).append(sAppend);
      var els=$("a",nPaging);var nPrevious=els[0],nNext=els[1];oSettings.oApi._fnBindAction(nPrevious,{action:"previous"},fnClickHandler);oSettings.oApi._fnBindAction(nNext,{action:"next"},fnClickHandler);if(!oSettings.aanFeatures.p){nPaging.id=oSettings.sTableId+"_paginate";nPrevious.id=oSettings.sTableId+"_previous";nNext.id=oSettings.sTableId+"_next";nPrevious.setAttribute("aria-controls",oSettings.sTableId);nNext.setAttribute("aria-controls",oSettings.sTableId)}},"fnUpdate":function(oSettings,fnCallbackDraw){if(!oSettings.aanFeatures.p)return;
      var oPaging=oSettings.oInstance.fnPagingInfo();var oClasses=oSettings.oClasses;var an=oSettings.aanFeatures.p;var nNode;for(var i=0,iLen=an.length;i<iLen;i++){if(oPaging.iPage===0)$("li:first",an[i]).addClass("disabled");else $("li:first",an[i]).removeClass("disabled");if(oPaging.iPage===oPaging.iTotalPages-1||oPaging.iTotalPages===0)$("li:last",an[i]).addClass("disabled");else $("li:last",an[i]).removeClass("disabled")}}},"bs_four_button":{"fnInit":function(oSettings,nPaging,fnCallbackDraw){var oLang=
      oSettings.oLanguage.oPaginate;var oClasses=oSettings.oClasses;var fnClickHandler=function(e){e.preventDefault();if(oSettings.oApi._fnPageChange(oSettings,e.data.action))fnCallbackDraw(oSettings)};$(nPaging).append('<ul class="pagination">'+'<li class="disabled"><a href="#" tabindex="'+oSettings.iTabIndex+'" class="'+oClasses.sPageButton+" "+oClasses.sPageFirst+'"><span class="glyphicon glyphicon-backward"></span>&nbsp;'+oLang.sFirst+"</a></li>"+'<li class="disabled"><a href="#" tabindex="'+oSettings.iTabIndex+
      '" class="'+oClasses.sPageButton+" "+oClasses.sPagePrevious+'"><span class="glyphicon glyphicon-chevron-left"></span>&nbsp;'+oLang.sPrevious+"</a></li>"+'<li><a href="#" tabindex="'+oSettings.iTabIndex+'" class="'+oClasses.sPageButton+" "+oClasses.sPageNext+'">'+oLang.sNext+'&nbsp;<span class="glyphicon glyphicon-chevron-right"></span></a></li>'+'<li><a href="#" tabindex="'+oSettings.iTabIndex+'" class="'+oClasses.sPageButton+" "+oClasses.sPageLast+'">'+oLang.sLast+'&nbsp;<span class="glyphicon glyphicon-forward"></span></a></li>'+
      "</ul>");var els=$("a",nPaging);var nFirst=els[0],nPrev=els[1],nNext=els[2],nLast=els[3];oSettings.oApi._fnBindAction(nFirst,{action:"first"},fnClickHandler);oSettings.oApi._fnBindAction(nPrev,{action:"previous"},fnClickHandler);oSettings.oApi._fnBindAction(nNext,{action:"next"},fnClickHandler);oSettings.oApi._fnBindAction(nLast,{action:"last"},fnClickHandler);if(!oSettings.aanFeatures.p){nPaging.id=oSettings.sTableId+"_paginate";nFirst.id=oSettings.sTableId+"_first";nPrev.id=oSettings.sTableId+"_previous";
      nNext.id=oSettings.sTableId+"_next";nLast.id=oSettings.sTableId+"_last"}},"fnUpdate":function(oSettings,fnCallbackDraw){if(!oSettings.aanFeatures.p)return;var oPaging=oSettings.oInstance.fnPagingInfo();var oClasses=oSettings.oClasses;var an=oSettings.aanFeatures.p;var nNode;for(var i=0,iLen=an.length;i<iLen;i++){if(oPaging.iPage===0){$("li:eq(0)",an[i]).addClass("disabled");$("li:eq(1)",an[i]).addClass("disabled")}else{$("li:eq(0)",an[i]).removeClass("disabled");$("li:eq(1)",an[i]).removeClass("disabled")}if(oPaging.iPage===
      oPaging.iTotalPages-1||oPaging.iTotalPages===0){$("li:eq(2)",an[i]).addClass("disabled");$("li:eq(3)",an[i]).addClass("disabled")}else{$("li:eq(2)",an[i]).removeClass("disabled");$("li:eq(3)",an[i]).removeClass("disabled")}}}},"bs_full":{"fnInit":function(oSettings,nPaging,fnCallbackDraw){var oLang=oSettings.oLanguage.oPaginate;var oClasses=oSettings.oClasses;var fnClickHandler=function(e){if(oSettings.oApi._fnPageChange(oSettings,e.data.action))fnCallbackDraw(oSettings)};$(nPaging).append('<ul class="pagination">'+
      '<li class="disabled"><a href="#" tabindex="'+oSettings.iTabIndex+'" class="'+oClasses.sPageButton+" "+oClasses.sPageFirst+'">'+oLang.sFirst+"</a></li>"+'<li class="disabled"><a href="#" tabindex="'+oSettings.iTabIndex+'" class="'+oClasses.sPageButton+" "+oClasses.sPagePrevious+'">'+oLang.sPrevious+"</a></li>"+'<li><a href="#" tabindex="'+oSettings.iTabIndex+'" class="'+oClasses.sPageButton+" "+oClasses.sPageNext+'">'+oLang.sNext+"</a></li>"+'<li><a href="#" tabindex="'+oSettings.iTabIndex+'" class="'+
      oClasses.sPageButton+" "+oClasses.sPageLast+'">'+oLang.sLast+"</a></li>"+"</ul>");var els=$("a",nPaging);var nFirst=els[0],nPrev=els[1],nNext=els[2],nLast=els[3];oSettings.oApi._fnBindAction(nFirst,{action:"first"},fnClickHandler);oSettings.oApi._fnBindAction(nPrev,{action:"previous"},fnClickHandler);oSettings.oApi._fnBindAction(nNext,{action:"next"},fnClickHandler);oSettings.oApi._fnBindAction(nLast,{action:"last"},fnClickHandler);if(!oSettings.aanFeatures.p){nPaging.id=oSettings.sTableId+"_paginate";
      nFirst.id=oSettings.sTableId+"_first";nPrev.id=oSettings.sTableId+"_previous";nNext.id=oSettings.sTableId+"_next";nLast.id=oSettings.sTableId+"_last"}},"fnUpdate":function(oSettings,fnCallbackDraw){if(!oSettings.aanFeatures.p)return;var oPaging=oSettings.oInstance.fnPagingInfo();var iPageCount=$.fn.dataTableExt.oPagination.iFullNumbersShowPages;var iPageCountHalf=Math.floor(iPageCount/2);var iPages=Math.ceil(oSettings.fnRecordsDisplay()/oSettings._iDisplayLength);var iCurrentPage=Math.ceil(oSettings._iDisplayStart/
      oSettings._iDisplayLength)+1;var sList="";var iStartButton,iEndButton,i,iLen;var oClasses=oSettings.oClasses;var anButtons,anStatic,nPaginateList,nNode;var an=oSettings.aanFeatures.p;var fnBind=function(j){oSettings.oApi._fnBindAction(this,{"page":j+iStartButton-1},function(e){if(oSettings.oApi._fnPageChange(oSettings,e.data.page))fnCallbackDraw(oSettings);e.preventDefault()})};if(oSettings._iDisplayLength===-1){iStartButton=1;iEndButton=1;iCurrentPage=1}else if(iPages<iPageCount){iStartButton=1;
      iEndButton=iPages}else if(iCurrentPage<=iPageCountHalf){iStartButton=1;iEndButton=iPageCount}else if(iCurrentPage>=iPages-iPageCountHalf){iStartButton=iPages-iPageCount+1;iEndButton=iPages}else{iStartButton=iCurrentPage-Math.ceil(iPageCount/2)+1;iEndButton=iStartButton+iPageCount-1}for(i=iStartButton;i<=iEndButton;i++)sList+=iCurrentPage!==i?'<li><a tabindex="'+oSettings.iTabIndex+'">'+oSettings.fnFormatNumber(i)+"</a></li>":'<li class="active"><a tabindex="'+oSettings.iTabIndex+'">'+oSettings.fnFormatNumber(i)+
      "</a></li>";for(i=0,iLen=an.length;i<iLen;i++){nNode=an[i];if(!nNode.hasChildNodes())continue;$("li:gt(1)",an[i]).filter(":not(li:eq(-2))").filter(":not(li:eq(-1))").remove();if(oPaging.iPage===0){$("li:eq(0)",an[i]).addClass("disabled");$("li:eq(1)",an[i]).addClass("disabled")}else{$("li:eq(0)",an[i]).removeClass("disabled");$("li:eq(1)",an[i]).removeClass("disabled")}if(oPaging.iPage===oPaging.iTotalPages-1||oPaging.iTotalPages===0){$("li:eq(-1)",an[i]).addClass("disabled");$("li:eq(-2)",an[i]).addClass("disabled")}else{$("li:eq(-1)",
      an[i]).removeClass("disabled");$("li:eq(-2)",an[i]).removeClass("disabled")}$(sList).insertBefore("li:eq(-2)",an[i]).bind("click",function(e){e.preventDefault();if(oSettings.oApi._fnPageChange(oSettings,parseInt($("a",this).text(),10)-1))fnCallbackDraw(oSettings)})}}}});
      if($.fn.DataTable.TableTools){$.extend(true,$.fn.DataTable.TableTools.classes,{"container":"DTTT btn-group","buttons":{"normal":"btn","disabled":"disabled"},"collection":{"container":"DTTT_dropdown dropdown-menu","buttons":{"normal":"","disabled":"disabled"}},"print":{"info":"DTTT_print_info modal"},"select":{"row":"active"}});$.extend(true,$.fn.DataTable.TableTools.DEFAULTS.oTags,{"collection":{"container":"ul","button":"li","liner":"a"}})};
    </script>
    <script>
      var json_data, data_table, shape_data, map_impl, map_grantee, choropleth_layer_impl, choropleth_layer_grantee, popup_impl, popup_grantee;
      var region_ids = [1,2,3,4,5,6,7,8,9,11,32];
      var no_data_color = "#999";
      var json_keys = {
        "grantee": "gsx$grantee" ,
        "grantee_location": "gsx$locationregion" ,
        "project": "gsx$projecttitle" ,
        "desc": "gsx$briefdescription" ,
        "budget": "gsx$budget" ,
        "start_date": "gsx$startdateddmmyy" ,
        "end_date": "gsx$enddateddmmyy" ,
        "type": "gsx$grantstype" ,
        "topic": "gsx$topicarea" ,
        "impl_location": "gsx$implementationregion" 
      };
      
      
        /***************************************************/
        /* map methods */
        /***************************************************/
        // get the color to show on the map
        function get_map_color(budget) {
          return budget > 1000000 ? '#006d2c' :
                 budget > 500000  ? '#2ca25f' :
                 budget > 100000  ? '#66c2a4' :
                 budget > 50000   ? '#99d8c9' :
                 budget > 10000   ? '#ccece6' :
                                    '#edf8fb';
        }

        
        /***************************************************/
        /* implimentation map functions */

        // create the map cloropleth map style
        function map_style_impl(feature) {
          return {
              fillColor: feature.properties.id == 0 ? no_data_color : get_map_color(feature.properties.impl_budget),
              weight: 2,
              opacity: 1,
              color: 'white',
              fillOpacity: 0.8
          };
        }

        // highlight map feature on rollover
        function highlightFeature_impl(e) {
          var layer = e.target;
          if (e.target.feature.properties.id > 0){
            layer.setStyle({
                weight: 5,
                color: 'white',
                fillOpacity: 0.9
            });

            if (!L.Browser.ie && !L.Browser.opera) {
              layer.bringToFront();
            }

            popup_impl.update(layer.feature.properties);
          }
        }
        
        // reset the highlight
        function resetHighlight_impl(e) {
          choropleth_layer_impl.resetStyle(e.target);
          popup_impl.update();
        }       
        
        // zoom into region
        function zoomToFeature_impl(e) {
          // select this region in the list
          $('select#filter_impl_location option[data-id="' + e.target.feature.properties.id.toString() + '"]').prop('selected', true).trigger('change');
        }         
        
        // apply listeners to each region in map 
        function onEachFeature_impl(feature, layer) {
          layer.on({
              mouseover: highlightFeature_impl,
              mouseout: resetHighlight_impl,
              click: zoomToFeature_impl
          });
        }

        /***************************************************/
        /* grantee map functions */

        // create the map cloropleth map style
        function map_style_grantee(feature) {
          return {
              fillColor: feature.properties.id == 0 ? no_data_color : get_map_color(feature.properties.grantee_budget),
              weight: 2,
              opacity: 1,
              color: 'white',
              fillOpacity: 0.8
          };
        }

        // highlight map feature on rollover
        function highlightFeature_grantee(e) {
          var layer = e.target;
          if (e.target.feature.properties.id > 0){
            layer.setStyle({
                weight: 5,
                color: 'white',
                fillOpacity: 0.9
            });

            if (!L.Browser.ie && !L.Browser.opera) {
              layer.bringToFront();
            }

            popup_grantee.update(layer.feature.properties);
          }
        }
        
        // reset the highlight
        function resetHighlight_grantee(e) {
          choropleth_layer_grantee.resetStyle(e.target);
          popup_grantee.update();
        }       
        
        // zoom into region
        function zoomToFeature_grantee(e) {
          // select this region in the list
          $('select#filter_grantee_location option[data-id="' + e.target.feature.properties.id.toString() + '"]').prop('selected', true).trigger('change');
        }         
        
        // apply listeners to each region in map 
        function onEachFeature_grantee(feature, layer) {
          layer.on({
              mouseover: highlightFeature_grantee,
              mouseout: resetHighlight_grantee,
              click: zoomToFeature_grantee
          });
        }
        
        /***************************************************/
        /* update filters, table, map */
        /***************************************************/

        // update the data table with the provided data
        function update_data_table(data){
          data_table.fnClearTable();
          data_table.fnAddData(data);
          data_table.fnDraw();
        }

        // get unique values from array
        function unique(array) {
          return $.grep(array, function(el, index) {
            return index == $.inArray(el, array);
          });
        }
        
        // convert budget string to float
        function convert_budget(budget){
          return parseFloat(budget.replace('$','').replace(',',''))
        }

        // reload the list that has the class name of 'filter_key', where key is passed in
        function reload_select_list(key, json_key, is_date, data){
          var existing_value = $('.filter_' + key + ' select').val();
//          if (existing_value == undefined || existing_value == '0'){
            var objs;
            if (is_date){
              objs = $.map(data, function(item,i){return item[json_key].$t.split('/')[2]});
            }else {
              objs = $.map(data, function(item,i){return item[json_key].$t});
            }
            var uniq_objs = unique(objs).sort();
            $('.filter_' + key + ' select').empty();
            $('.filter_' + key + ' select')
               .append($("<option></option>")
               .attr("value",'0')
               .text('All')); 
            $.each(uniq_objs, function(index, value) {   
                 $('.filter_' + key + ' select')
                     .append($("<option></option>")
                     .attr("value",value)
                     .text(value)); 
            });
            $('.filter_' + key + ' select').val(existing_value);
//          }
          $('.filter_' + key + '').show();
        }

        // compute the implementation budget totals and number of projects in each region
        function compute_impl_region_totals(data){
          regions = {};
          var region_name, region_data, region_budget;
          
          $.each(region_ids, function(index, region_id){
            regions[region_id] = {projects: 0, budget: 0, name: ''};
            
            // reset budget
            region_budget = 0;
            
            // get the value (region name) for this id
            region_name = $('.filter_impl_location select option[data-id="' + region_id + '"]').val();

            // save the name
            regions[region_id].name = region_name;
            
            // pull out the data for this region
            region_data = $.grep(data, function( item, i ) { return item[json_keys['impl_location']].$t.indexOf(region_name) != -1});

            if (region_data.length > 0){
              // data exists

              // - get # of projects
              regions[region_id].projects = region_data.length;
              
              // - sum budget
              $.each($.map(region_data, function(item,i){return item[json_keys['budget']].$t}),function() {
                region_budget += convert_budget(this);
              });              
              regions[region_id].budget = region_budget;
              
            }
            
          });          
          
          return regions
        }
        

        // compute the grantee budget totals and number of projects in each region
        function compute_grantee_region_totals(data){
          regions = {};
          var region_name, region_data, region_budget;
          
          $.each(region_ids, function(index, region_id){
            regions[region_id] = {projects: 0, budget: 0, name: ''};
            
            // reset budget
            region_budget = 0;
            
            // get the value (region name) for this id
            region_name = $('.filter_grantee_location select option[data-id="' + region_id + '"]').val();

            // save the name
            regions[region_id].name = region_name;
            
            // pull out the data for this region
            region_data = $.grep(data, function( item, i ) { return item[json_keys['grantee_location']].$t.indexOf(region_name) != -1});

            if (region_data.length > 0){
              // data exists

              // - get # of grantees
              regions[region_id].grantees = region_data.length;
              
              // - sum budget
              $.each($.map(region_data, function(item,i){return item[json_keys['budget']].$t}),function() {
                region_budget += convert_budget(this);
              });              
              regions[region_id].budget = region_budget;
              
            }
            
          });          
          
          return regions
        }
        

        // compute budget total for current data being displayed
        function compute_budget_total(data){

          budget = 0;      
          count = 0;    
          $.each($.map(data, function(item,i){return item[json_keys['budget']].$t}),function() {
            budget += convert_budget(this);
            count += 1;
          });              
        
          var text = '';
          if (count == 0){
            text = '0 Projects';
          }else if (count == 1){
            text = numeral(budget).format('$0,0.00') + ' in ' + count + ' Project';
          }else {
            text = numeral(budget).format('$0,0.00') + ' in ' + count + ' Projects';
          }
          
          $('.table_container .budget_total').html(text);
        }
        
        // merge the data summary into the shape data so can map choropleth of projects
        function merge_shape_impl_data(shapes, data){
          var data_item;
          var region_totals = compute_impl_region_totals(data);
          
          $.each(shapes, function(index, shape){
            if (shape.properties.id > 0){
              data_item = region_totals[shape.properties.id];
              
              shape.properties['impl_budget'] = data_item.budget;
              shape.properties['impl_projects'] = data_item.projects;
              shape.properties['impl_name'] = data_item.name;
            }
          });
        }
        
        // merge the data summary into the shape data so can map choropleth of grantees
        function merge_shape_grantee_data(shapes, data){
          var data_item;
          var region_totals = compute_grantee_region_totals(data);
          
          $.each(shapes, function(index, shape){
            if (shape.properties.id > 0){
              data_item = region_totals[shape.properties.id];
              
              shape.properties['grantee_budget'] = data_item.budget;
              shape.properties['grantee_grantees'] = data_item.grantees;
              shape.properties['grantee_name'] = data_item.name;
            }
          });
        }
        
        // update the datatable and filters using the data provided
        function refresh_data(data){
          // compute and show budget total
          compute_budget_total(data);
          
          // update the map with the shapes
          merge_shape_impl_data(shape_data, data);
          if (choropleth_layer_impl != undefined){
            // remove the previous layer  
            map_impl.removeLayer(choropleth_layer_impl);
          }
          choropleth_layer_impl = L.geoJson(shape_data, {style: map_style_impl, onEachFeature: onEachFeature_impl}).addTo(map_impl);

          merge_shape_grantee_data(shape_data, data);
          if (choropleth_layer_grantee != undefined){
            // remove the previous layer  
            map_grantee.removeLayer(choropleth_layer_grantee);
          }
          choropleth_layer_grantee = L.geoJson(shape_data, {style: map_style_grantee, onEachFeature: onEachFeature_grantee}).addTo(map_grantee);
          
          
          // update the data table with the new data
          update_data_table(data);

          // reload the lists
          reload_select_list('type', json_keys['type'], false, data);
          reload_select_list('topic', json_keys['topic'], false, data);
          reload_select_list('start_date', json_keys['start_date'], true, data);
          reload_select_list('end_date', json_keys['end_date'], true, data);   
        }
        


      $(document).ready(function(){


        /***************************************************/
        /* special tabl sorts */
        /***************************************************/
        jQuery.extend( jQuery.fn.dataTableExt.oSort, {
            "formatted-num-pre": function ( a ) {
                a = (a === "-" || a === "") ? 0 : a.replace( /[^\d\-\.]/g, "" );
                return parseFloat( a );
            },
         
            "formatted-num-asc": function ( a, b ) {
                return a - b;
            },
         
            "formatted-num-desc": function ( a, b ) {
                return b - a;
            }
        } );

        jQuery.fn.dataTableExt.oSort['us_date-asc'] = function (a, b) {
            var x = new Date(a),
             y = new Date(b);
            return ((x < y) ? -1 : ((x > y) ? 1 : 0));
        };

        jQuery.fn.dataTableExt.oSort['us_date-desc'] = function (a, b) {
            var x = new Date(a),
             y = new Date(b);
            return ((x < y) ? 1 : ((x > y) ? -1 : 0));
        };




        /***************************************************/
        /* load map and data json */
        /***************************************************/
        
        // get the shape json data
        $.getJSON( "./data/regions.json", function( shapes ) {
          shape_data = shapes;
          
    			var url = 'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
          /***************************************************/
          // load the implimentation map
          map_impl = L.map('map_impl').setView([42.293564192170095, 43.04443359375,], 7);
          L.tileLayer(url, {
              maxZoom: 18,
              opacity: 0.5
          }).addTo(map_impl);
          
          // add legend
          var legend = L.control({position: 'bottomleft'});
          legend.onAdd = function (map) {
            var div = L.DomUtil.create('div', 'popup legend'),
                grades = [0, 10000, 50000, 100000, 500000, 1000000],
                labels = [];
            // loop through our density intervals and generate a label with a colored square for each interval
            for (var i = 0; i < grades.length; i++) {
                div.innerHTML +=
                    '<i style="background:' + get_map_color(grades[i] + 1) + '"></i> ' +
                    numeral(grades[i]).format('$0,0') + (grades[i + 1] ? '&ndash;' + numeral(grades[i+1]).format('$0,0') + '<br>' : '+');
            }
            return div;
          };
          legend.addTo(map_impl);

          // add popup
          popup_impl = L.control();
          popup_impl.onAdd = function (map) {
            this._div = L.DomUtil.create('div', 'popup');
            this.update();
            return this._div;
          };
          // method that we will use to update the control based on feature properties passed
          popup_impl.update = function (props) {
            this._div.innerHTML = '<h4>Implementation Location Summary</h4>' +  
                (props ? '<b>' + props.impl_name + '</b>' + 
                          '<br><b>Projects:</b> ' + numeral(props.impl_projects).format('0,0') + 
                          '<br><b>Total Budget:</b> ' + numeral(props.impl_budget).format('$0,0.00')
                : 'Hover over a region');
          };
          popup_impl.addTo(map_impl);          

          /***************************************************/
          // load the grantee map
          map_grantee = L.map('map_grantee').setView([42.293564192170095, 43.04443359375,], 7);
          L.tileLayer(url, {
              maxZoom: 18,
              opacity: 0.5
          }).addTo(map_grantee);
          
          // add legend
          var legend = L.control({position: 'bottomleft'});
          legend.onAdd = function (map) {
            var div = L.DomUtil.create('div', 'popup legend'),
                grades = [0, 10000, 50000, 100000, 500000, 1000000],
                labels = [];
            // loop through our density intervals and generate a label with a colored square for each interval
            for (var i = 0; i < grades.length; i++) {
                div.innerHTML +=
                    '<i style="background:' + get_map_color(grades[i] + 1) + '"></i> ' +
                    numeral(grades[i]).format('$0,0') + (grades[i + 1] ? '&ndash;' + numeral(grades[i+1]).format('$0,0') + '<br>' : '+');
            }
            return div;
          };
          legend.addTo(map_grantee);

          // add popup
          popup_grantee = L.control();
          popup_grantee.onAdd = function (map) {
            this._div = L.DomUtil.create('div', 'popup');
            this.update();
            return this._div;
          };
          // method that we will use to update the control based on feature properties passed
          popup_grantee.update = function (props) {
            this._div.innerHTML = '<h4>Grantee Location Summary</h4>' +  
                (props ? '<b>' + props.grantee_name + '</b>' + 
                          '<br><b>Grantees:</b> ' + numeral(props.grantee_grantees).format('0,0') + 
                          '<br><b>Total Budget:</b> ' + numeral(props.grantee_budget).format('$0,0.00')
                : 'Hover over a region');
          };
          popup_grantee.addTo(map_grantee);          

          
          /***************************************************/
          // get the json data and then load the page
          $.getJSON( "https://spreadsheets.google.com/feeds/list/19RqNkt9AlAFFTsQJAIwK605husVRzo0-YtSY7J0S7pU/1567754387/public/values?alt=json", function( data ) {
            json_data = data.feed.entry;

            // load data table
            data_table = $('#data_table').dataTable({
              "sPaginationType": "bs_normal",
              "bProcessing": true,
              "bSortClasses": false,
              "iDisplayLength": 20,
              "aLengthMenu": [[20, 40, 60, 80], [20, 40, 60, 80]],
              "oLanguage": {
                "sSearch": "Search: "
              },
              "aoColumns": [
                  { "mData": json_keys['grantee'] + '.$t' },
                  { "mData": json_keys['project'] + '.$t' },
                  { "mData": json_keys['desc'] + '.$t' },
                  { "mData": json_keys['budget'] + '.$t', "sType": "formatted-num"},
                  { "mData": json_keys['start_date'] + '.$t', "sType": "us_date" },
                  { "mData": json_keys['end_date'] + '.$t', "sType": "us_date" },
                  { "mData": json_keys['grantee_location'] + '.$t' },
                  { "mData": json_keys['impl_location'] + '.$t' },
                  { "mData": json_keys['type'] + '.$t' },
                  { "mData": json_keys['topic'] + '.$t' }
                  
              ]
            });

            // load the data into the table and load the filters
            refresh_data(json_data);          



          });
        });

  
        // when the tab turns on make the grantee map show properly
        $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
          if ($(e.target).data('type') == 'grantee' && $(e.target).data('resize') != 'true'){
            map_grantee._onResize(); 
            $(e.target).data('resize', 'true');
          }
        })
        
        // register clear filters event
        $('button#reset_filters').click(function(){
          refresh_data(json_data);
          
          // now reset all select values to 0
          $('.filter_container select').each(function(){
            $(this).val('0');
          });
        });

        // register filter type event
        $('.filter_container select').change(function(){
          // for each filter in the container
          // - build a filter statement if needed
          // - then filter the data
          var filters = [];
          // for each select box, get filter value if one is selected
          $('.filter_container select').each(function(){
            if ($(this).val() != "0"){
              filters.push([json_keys[$(this).parent().data('type')], $(this).val(), $(this).parent().data('analysis')]);
            }
          });

          var filter_data;
          // if no filters, then default to original data
          // else, filter the data
          if (filters.length == 0){
            filter_data = json_data;
          }else{
            console.log(filters);
            filter_data = $.grep(json_data, function( item, i ) {
              var test = true;
              $.each(filters, function(index, filter) {   
                if (filter[2] != undefined && filter[2] == 'between'){
                  // see if value is between these bounds
                  // filter value: x-y
                  // - x = lower limit (>= to)
                  // - y = upper limit (<)
                  var between = filter[1].split('-');
                  if (between[0].length > 0){
                    test = test && convert_budget(item[filter[0]].$t) >= between[0];
                  }                 
                  if (between[1].length > 0){
                    test = test && convert_budget(item[filter[0]].$t) < between[1];
                  }                 
                  
                } else if (filter[2] != undefined && filter[2] == 'year'){
                  // only compare the year of the date
                  test = test && item[filter[0]].$t.split('/')[2] == filter[1];
                } else if (filter[2] != undefined && filter[2] == 'in-string'){
                  // see if the value is anywhere in the string
                  test = test && item[filter[0]].$t.indexOf(filter[1]) != -1;
                }else{
                  // do basic == comparison
                  test = test && item[filter[0]].$t == filter[1];
                }
              });
              return ( test );
            });
          }

          // update the data table and filters
          refresh_data(filter_data);          


        });  
        
        
      });
    </script>
  </body>
</html>

