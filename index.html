<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.css" />
    <link rel="stylesheet" type="text/css" href="http://ajax.aspnetcdn.com/ajax/jquery.dataTables/1.9.4/css/jquery.dataTables.css">
    <link rel="stylesheet" type="text/css" href="css/datatables.css" />
    <title>EWMI G-PAC Sub-Grants</title>
    
    <style>
      .popup {
        padding: 6px 8px;
        font: 14px/16px Arial, Helvetica, sans-serif;
        background: white;
        background: rgba(255,255,255,0.8);
        box-shadow: 0 0 15px rgba(0,0,0,0.2);
        border-radius: 5px;
      }
      .popup h4 {
        margin: 0 0 5px;
        color: #777;
      }

      .legend {
        line-height: 18px;
        color: #000;
      }
      .legend i {
        width: 18px;
        height: 18px;
        float: left;
        margin-right: 8px;
        opacity: 0.9;
      }

      .filter_container{
        margin-bottom: 20px;
      }
      .map_container{
        width: 700px; 
        margin: 0 auto;
        margin-bottom: 20px;
      }
      #map{
        height: 300px;
      }
    </style>
  </head>
  <body>

    <div class="container">
      <div class="filter_container">
        <div class="row">
          <div class="filter_budget col-sm-4" data-type="budget" data-analysis="between">
            <label for="filter_budget">Budget:</label>
            <select id="filter_budget">
              <option value="0">All</option>
              <option value="-10000">&lt; 10,000</option>
              <option value="10000-20000">10,000 - 20,000</option>
              <option value="20000-">&gt; 20,000</option>
            </select>
          </div>
          <div class="filter_start_date col-sm-4" style="display:none;" data-type="start_date" data-analysis="year">
            <label for="filter_start_date">Start Year:</label>
            <select id="filter_start_date"></select>
          </div>
          <div class="filter_end_date col-sm-4" style="display:none;" data-type="end_date" data-analysis="year">
            <label for="filter_end_date">End Year:</label>
            <select id="filter_end_date"></select>
          </div>
        </div>
        <div class="row">
          <div class="filter_type col-sm-4" style="display:none;" data-type="type">
            <label for="filter_type">Grant Type:</label>
            <select id="filter_type"></select>
          </div>
          <div class="filter_topic col-sm-4" style="display:none;" data-type="topic">
            <label for="filter_topic">Topic / Area:</label>
            <select id="filter_topic"></select>
          </div>
          <div class="filter_region col-sm-4" data-type="budget_location" data-analysis="in-string">
            <label for="filter_region">Region:</label>
            <select id="filter_region">
              <option value="0">All</option>
              <option value="Adjara" data-id="1">Adjara</option>
              <option value="Guria" data-id="2">Guria</option>
              <option value="Imereti" data-id="3">Imereti</option>
              <option value="Kakheti" data-id="4">Kakheti</option>
              <option value="Kvemo Kartli" data-id="5">Kvemo Kartli</option>
              <option value="Mtskheta-Mtianeti" data-id="7">Mtskheta-Mtianeti</option>
              <option value="Racha-Lechkumi / Kvemo Svaneti" data-id="8">Racha-Lechkumi / Kvemo Svaneti</option>
              <option value="Samegrelo / Zemo Svaneti" data-id="11">Samegrelo / Zemo Svaneti</option>
              <option value="Samtskhe-Javakheti" data-id="6">Samtskhe-Javakheti</option>
              <option value="Shida Kartli" data-id="9">Shida Kartli</option>
              <option value="Tbilisi" data-id="32">Tbilisi</option>
            </select>
          </div>
        </div>
      </div>
      
      
      <div class="map_container">
        <div id="map">
        </div>
      </div>      
      
      <div class="table_container table-responsive">
        <table id="data_table" class="table table-striped table-bordered table-hover" >
          <thead>
            <tr>
              <th>
                Grantee
              </th>
              <th>
                Grantee Location
              </th>
              <th>
                Project Title
              </th>
              <th>
                Description
              </th>
              <th>
                Implementation Region
              </th>
              <th>
                Budget
              </th>
              <th>
                Start Date
              </th>
              <th>
                End Date
              </th>
              <th>
                Grant Type
              </th>
              <th>
                Topic / Area
              </th>
            </tr>
          </thead>
          <tbody>
          </tbody>
        </table>
      </div>
    </div>      



    <script type="text/javascript" charset="utf8" src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.8.2.min.js"></script>
    <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/numeral.js/1.4.5/numeral.min.js"></script>
    <script src="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.js"></script>
    <script type="text/javascript" charset="utf8" src="http://ajax.aspnetcdn.com/ajax/jquery.dataTables/1.9.4/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="js/datatables.js"></script>
    <script>
      var json_data, shape_data, data_table, map, choropleth_layer, popup;
      var region_ids = [1,2,3,4,5,6,7,8,9,11,32];
      var no_data_color = "#999";
      var json_keys = {
        "grantee": "gsx$grantee" ,
        "org_location": "gsx$locationregion" ,
        "project": "gsx$projecttitle" ,
        "desc": "gsx$briefdescription" ,
        "budget": "gsx$budget" ,
        "start_date": "gsx$startdateddmmyy" ,
        "end_date": "gsx$enddateddmmyy" ,
        "type": "gsx$grantstype" ,
        "topic": "gsx$topicarea" ,
        "budget_location": "gsx$implementationregion" 
      };
      
      
        /***************************************************/
        /* map methods */
        /***************************************************/
        
        // get the color to show on the map
        function get_map_color(budget) {
          return budget > 1000000 ? '#006d2c' :
                 budget > 500000  ? '#2ca25f' :
                 budget > 100000  ? '#66c2a4' :
                 budget > 50000   ? '#99d8c9' :
                 budget > 10000   ? '#ccece6' :
                                    '#edf8fb';
        }

        // create the map cloropleth map style
        function map_style(feature) {
          return {
              fillColor: feature.properties.id == 0 ? no_data_color : get_map_color(feature.properties.budget),
              weight: 2,
              opacity: 1,
              color: 'white',
              fillOpacity: 0.8
          };
        }

        // highlight map feature on rollover
        function highlightFeature(e) {
          var layer = e.target;
          if (e.target.feature.properties.id > 0){
            layer.setStyle({
                weight: 5,
                color: 'white',
                fillOpacity: 0.9
            });

            if (!L.Browser.ie && !L.Browser.opera) {
              layer.bringToFront();
            }

            popup.update(layer.feature.properties);
          }
        }
        
        // reset the highlight
        function resetHighlight(e) {
          choropleth_layer.resetStyle(e.target);
          popup.update();
        }       
        
        // zoom into region
        function zoomToFeature(e) {
          map.fitBounds(e.target.getBounds());
        }         
        
        // apply listeners to each region in map 
        function onEachFeature(feature, layer) {
          layer.on({
              mouseover: highlightFeature,
              mouseout: resetHighlight,
              click: zoomToFeature
          });
        }
        
        /***************************************************/
        /* update filters, table, map */
        /***************************************************/

        // update the data table with the provided data
        function update_data_table(data){
          data_table.fnClearTable();
          data_table.fnAddData(data);
          data_table.fnDraw();
        }

        // get unique values from array
        function unique(array) {
          return $.grep(array, function(el, index) {
            return index == $.inArray(el, array);
          });
        }

        // reload the list that has the class name of 'filter_key', where key is passed in
        function reload_select_list(key, json_key, is_date, data){
          var existing_value = $('.filter_' + key + ' select').val();
//          if (existing_value == undefined || existing_value == '0'){
            var objs;
            if (is_date){
              objs = $.map(data, function(item,i){return item[json_key].$t.split('/')[2]});
            }else {
              objs = $.map(data, function(item,i){return item[json_key].$t});
            }
            var uniq_objs = unique(objs).sort();
            $('.filter_' + key + ' select').empty();
            $('.filter_' + key + ' select')
               .append($("<option></option>")
               .attr("value",'0')
               .text('All')); 
            $.each(uniq_objs, function(index, value) {   
                 $('.filter_' + key + ' select')
                     .append($("<option></option>")
                     .attr("value",value)
                     .text(value)); 
            });
            $('.filter_' + key + ' select').val(existing_value);
//          }
          $('.filter_' + key + '').show();
        }

        // compute the budget totals and number of projects in each region
        function compute_region_totals(data){
          regions = {};
          var region_name, region_data, region_budget;
          
          $.each(region_ids, function(index, region_id){
            regions[region_id] = {projects: 0, budget: 0, name: ''};
            
            // reset budget
            region_budget = 0;
            
            // get the value (region name) for this id
            region_name = $('.filter_region select option[data-id="' + region_id + '"]').val();

            // save the name
            regions[region_id].name = region_name;
            
            // pull out the data for this region
            region_data = $.grep(data, function( item, i ) { return item[json_keys['budget_location']].$t.indexOf(region_name) != -1});

            if (region_data.length > 0){
              // data exists

              // - get # of projects
              regions[region_id].projects = region_data.length;
              
              // - sum budget
              $.each($.map(region_data, function(item,i){return item[json_keys['budget']].$t}),function() {
                region_budget += parseFloat(this.replace('$','').replace(',',''));
              });              
              regions[region_id].budget = region_budget;
              
            }
            
          });          
          
          return regions
        }
        
        // merge the data summary into the shape data so can map choropleth 
        function merge_shape_budget_data(shapes, data){
          var data_item;
          var region_totals = compute_region_totals(data);
          
          $.each(shapes, function(index, shape){
            if (shape.properties.id > 0){
              data_item = region_totals[shape.properties.id];
              
              shape.properties['budget'] = data_item.budget;
              shape.properties['projects'] = data_item.projects;
              shape.properties['name'] = data_item.name;
            }
          });
        }
        

        // update the datatable and filters using the data provided
        function refresh_data(data){
          // update the map with the shapes
          merge_shape_budget_data(shape_data, data)
          if (choropleth_layer != undefined){
            // remove the previous layer  
            map.removeLayer(choropleth_layer);
          }
          choropleth_layer = L.geoJson(shape_data, {style: map_style, onEachFeature: onEachFeature}).addTo(map);
          
          // update the data table with the new data
          update_data_table(data);

          // reload the lists
          reload_select_list('type', json_keys['type'], false, data);
          reload_select_list('topic', json_keys['topic'], false, data);
          reload_select_list('start_date', json_keys['start_date'], true, data);
          reload_select_list('end_date', json_keys['end_date'], true, data);   
        }
        


      $(document).ready(function(){


        /***************************************************/
        /* special tabl sorts */
        /***************************************************/
        jQuery.extend( jQuery.fn.dataTableExt.oSort, {
            "formatted-num-pre": function ( a ) {
                a = (a === "-" || a === "") ? 0 : a.replace( /[^\d\-\.]/g, "" );
                return parseFloat( a );
            },
         
            "formatted-num-asc": function ( a, b ) {
                return a - b;
            },
         
            "formatted-num-desc": function ( a, b ) {
                return b - a;
            }
        } );

        jQuery.fn.dataTableExt.oSort['us_date-asc'] = function (a, b) {
            var x = new Date(a),
             y = new Date(b);
            return ((x < y) ? -1 : ((x > y) ? 1 : 0));
        };

        jQuery.fn.dataTableExt.oSort['us_date-desc'] = function (a, b) {
            var x = new Date(a),
             y = new Date(b);
            return ((x < y) ? 1 : ((x > y) ? -1 : 0));
        };




        /***************************************************/
        /* load map and data json */
        /***************************************************/
        
        // get the shape json data
        $.getJSON( "./data/regions.json", function( shapes ) {
          shape_data = shapes;
          
          // load the map
    			var url = 'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
          map = L.map('map').setView([42.293564192170095, 43.04443359375,], 7);
          L.tileLayer(url, {
              maxZoom: 18,
              opacity: 0.5
          }).addTo(map);
          
          // add legend
          var legend = L.control({position: 'bottomleft'});
          legend.onAdd = function (map) {
            var div = L.DomUtil.create('div', 'popup legend'),
                grades = [0, 10000, 50000, 100000, 500000, 1000000],
                labels = [];
            // loop through our density intervals and generate a label with a colored square for each interval
            for (var i = 0; i < grades.length; i++) {
                div.innerHTML +=
                    '<i style="background:' + get_map_color(grades[i] + 1) + '"></i> ' +
                    numeral(grades[i]).format('$0,0') + (grades[i + 1] ? '&ndash;' + numeral(grades[i+1]).format('$0,0') + '<br>' : '+');
            }
            return div;
          };
          legend.addTo(map);

          // add popup
          popup = L.control();
          popup.onAdd = function (map) {
            this._div = L.DomUtil.create('div', 'popup');
            this.update();
            return this._div;
          };
          // method that we will use to update the control based on feature properties passed
          popup.update = function (props) {
            this._div.innerHTML = '<h4>Region Summary</h4>' +  
                (props ? '<b>' + props.name + '</b>' + 
                          '<br><b>Projects:</b> ' + numeral(props.projects).format('0,0') + 
                          '<br><b>Total Budget:</b> ' + numeral(props.budget).format('$0,0.00')
                : 'Hover over a region');
          };
          popup.addTo(map);          
          
          // get the json data and then load the page
          $.getJSON( "https://spreadsheets.google.com/feeds/list/19RqNkt9AlAFFTsQJAIwK605husVRzo0-YtSY7J0S7pU/1567754387/public/values?alt=json", function( data ) {
            json_data = data.feed.entry;

            // load data table
            data_table = $('#data_table').dataTable({
              "sPaginationType": "bs_normal",
              "bProcessing": true,
              "bSortClasses": false,
              "iDisplayLength": 20,
              "aLengthMenu": [[20, 40, 60, 80], [20, 40, 60, 80]],
              "aoColumns": [
                  { "mData": json_keys['grantee'] + '.$t' },
                  { "mData": json_keys['org_location'] + '.$t' },
                  { "mData": json_keys['project'] + '.$t' },
                  { "mData": json_keys['desc'] + '.$t' },
                  { "mData": json_keys['budget_location'] + '.$t' },
                  { "mData": json_keys['budget'] + '.$t', "sType": "formatted-num"},
                  { "mData": json_keys['start_date'] + '.$t', "sType": "us_date" },
                  { "mData": json_keys['end_date'] + '.$t', "sType": "us_date" },
                  { "mData": json_keys['type'] + '.$t' },
                  { "mData": json_keys['topic'] + '.$t' }
                  
              ]
            });

            // load the data into the table and load the filters
            refresh_data(json_data);          



          });
        });


        // register filter type event
        $('.filter_container select').change(function(){
          // for each filter in the container
          // - build a filter statement if needed
          // - then filter the data
          var filters = [];
          // for each select box, get filter value if one is selected
          $('.filter_container select').each(function(){
            if ($(this).val() != "0"){
              filters.push([json_keys[$(this).parent().data('type')], $(this).val(), $(this).parent().data('analysis')]);
            }
          });

          var filter_data;
          // if no filters, then default to original data
          // else, filter the data
          if (filters.length == 0){
            filter_data = json_data;
          }else{
            console.log(filters);
            filter_data = $.grep(json_data, function( item, i ) {
              var test = true;
              $.each(filters, function(index, filter) {   
                if (filter[2] != undefined && filter[2] == 'between'){
                  // see if value is between these bounds
                  // filter value: x-y
                  // - x = lower limit (>= to)
                  // - y = upper limit (<)
                  var between = filter[1].split('-');
                  if (between[0].length > 0){
                    test = test && item[filter[0]].$t >= between[0];
                  }                 
                  if (between[1].length > 0){
                    test = test && item[filter[0]].$t < between[1];
                  }                 
                  
                } else if (filter[2] != undefined && filter[2] == 'year'){
                  // only compare the year of the date
                  test = test && item[filter[0]].$t.split('/')[2] == filter[1];
                } else if (filter[2] != undefined && filter[2] == 'in-string'){
                  // see if the value is anywhere in the string
                  test = test && item[filter[0]].$t.indexOf(filter[1]) != -1;
                }else{
                  // do basic == comparison
                  test = test && item[filter[0]].$t == filter[1];
                }
              });
              return ( test );
            });
          }

          // update the data table and filters
          refresh_data(filter_data);          


        });  
        
        
      });
    </script>
  </body>
</html>

